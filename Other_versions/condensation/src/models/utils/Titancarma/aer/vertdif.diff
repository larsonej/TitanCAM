1c1
<        subroutine vertdif(ixy)
---
>        subroutine vertdif
11a12,15
> c  Modified  Sep-1997  (McKie)
> c  Remove <ixy> from arg list
> c  <ixy> now available as a global var in common block.
> c
13c17
< c    ixy
---
> c    None.
26c30
<       if( DEBUG ) write(LUNOPRT,'(/,a)') 'Enter vertdif'
---
> c     if( DEBUG ) write(LUNOPRT,'(/,a)') 'Enter vertdif'
33,34c37
<         dz_avg = delz2(ixy,k)                            ! layer thickness
<         rhofact = log( rhoa2(ixy,k)/rhoa2(ixy,k-1) )
---
>         dz_avg = dz2(ixy,k)                            ! layer thickness
36,37c39
< c  <ttheta> is the factor that determines the weighting between
< c  diffusion and advection.
---
> c  Check the vertical coordinate
39,41c41,58
<         ttheta = rhofact
<         if( ttheta .ge. 0. ) then
<           ttheta = min(ttheta,POWMAX)
---
>         if( igridv .eq. I_CART ) then
>           rhofact = log(  rhoa2(ixy,k)/rhoa2(ixy,k-1)
>      $                  * zmet2(ixy,k-1)/zmet2(ixy,k) )
>           xex = rhoa2(ixy,k-1)/rhoa2(ixy,k) *
>      $          zmet2(ixy,k)/zmet2(ixy,k-1)
>           vertdifu(k) = ( rhofact * dkz2(ixy,k)/dz_avg ) /
>      $                  ( 1. - xex )
> 
>           vertdifd(k) = vertdifu(k) * xex
> c
> c  ...else you're in sigma coordinates...
> c
>         elseif( igridv .eq. I_SIG ) then
>           vertdifu(k) = dkz2(ixy,k)/dz_avg
>           vertdifd(k) = dkz2(ixy,k)/dz_avg
> c
> c  ...else write an error (maybe redundant)...
> c  
43c60,61
<           ttheta = max(ttheta,-POWMAX)
---
>           write(LUNOPRT,*) 'Invalid vertical grid type'
>           stop 1
46,51d63
<         vertdifu(k) = ( rhofact * dkv2(ixy,k)/dz_avg ) /
<      $              ( 1. - exp(-ttheta) )
< 
<         vertdifd(k) = vertdifu(k) * exp(-ttheta)
< c       print *,k,ttheta,exp(-ttheta),vertdifd(k)
< 
60a73
> 
70c83
<         dz_avg = delz2(ixy,1)                            ! layer thickness
---
>         dz_avg = dz2(ixy,1)                            ! layer thickness
79,81c92,97
<         vertdifu(1) = ( rhofact * dkv2(ixy,1)/dz_avg ) /
<      $                ( 1. - exp(-ttheta) )
<         vertdifd(1) = vertdifu(1) * exp(-ttheta)
---
>         xex = exp(-ttheta)
>         if( abs(ONE - xex) .lt. ALMOST_ZERO ) xex = ALMOST_ONE
> 
>         vertdifu(1) = ( rhofact * dkz2(ixy,1)/dz_avg ) /
>      $                ( 1. - xex )
>         vertdifd(1) = vertdifu(1) * xex
85c101
<         dz_avg = delz2(ixy,nz)                            ! layer thickness
---
>         dz_avg = dz2(ixy,NZ)                            ! layer thickness
94,97c110,111
<         vertdifu(nz+1) = ( rhofact * dkv2(ixy,nz+1)/dz_avg ) /
<      $                   ( 1. - exp(-ttheta) )
<         vertdifd(nz+1) = vertdifu(nz+1) * exp(-ttheta)
<       endif
---
>         xex = exp(-ttheta)
>         if( abs(ONE - xex) .lt. ALMOST_ZERO ) xex = ALMOST_ONE
99,102c113,116
< c      do k=0,nz
< c       print *,k,ttheta,exp(-ttheta),vertdifd(k)
< c      enddo
< 
---
>         vertdifu(NZ+1) = ( rhofact * dkz2(ixy,NZ+1)/dz_avg ) /
>      $                   ( 1. - xex )
>         vertdifd(NZ+1) = vertdifu(NZ+1) * xex
>       endif
